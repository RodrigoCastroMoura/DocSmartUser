{% extends "base.html" %}

{% block content %}

<div class="page-container">
    <div class="header-title">
        <a href="/document_types" class="back-link">
            <i data-feather="arrow-left"></i>
            Back to Document types
        </a>
    </div>
    <div class="filter-section">
        <div class="filter-header">
            <h2><i data-feather="file-text"></i> {{ document_type.name if document_type else 'Unknown Document type' }}</h2>
            <button class="action-btn primary" onclick="showAddDocumentModal()">
                <i data-feather="plus"></i> Add Document
            </button>
        </div>
        <div class="filter-grid">
            <div class="filter-group">
                {{ document_type.titulo if document_type else 'Unknown Document titulo' }}
            </div>
        </div>
    </div>
    <div class="content-grid">
        <div id="documentsContent">
            <div class="documents-grid">
                <div class="no-data">
                    <i data-feather="inbox"></i>
                    <p>Loading documents...</p>
                </div>
            </div>
            <div class="pagination-controls">
                <button class="action-btn" onclick="changePage(currentPage - 1)" id="prevPage" disabled>
                    <i data-feather="chevron-left"></i> <span class="btn-text">Previous</span>
                </button>
                <span id="pageInfo">Page 1</span>
                <button class="action-btn" onclick="changePage(currentPage + 1)" id="nextPage" disabled>
                    <span class="btn-text">Next</span> <i data-feather="chevron-right"></i>
                </button>
            </div>
        </div>
    </div>
</div>
</div>
<!-- Add Document Modal -->
<div id="addDocumentModal" class="modal">
<div class="modal-content">
    <h3>Add Document</h3>
    <form id="addDocumentForm" onsubmit="createDocument(event)">
        <div class="form-group">
            <label for="documentTitle">Document Title</label>
            <input type="text" id="documentTitle" name="titulo" >
        </div>
        <div class="form-group">
            <label for="documentFile">Upload File</label>
            <input type="file" id="documentFile" name="file" required>
        </div>
        <div class="modal-actions">
            <button type="button" class="action-btn" onclick="hideModal('addDocumentModal')">Cancel</button>
            <button type="submit" class="action-btn primary">Upload</button>
            <input type="hidden" name="department_id" id="department_id" value="{{category.department_id}}">
            <input type="hidden" name="category_id" id="category_id" value="{{category.id}}">
            <input type="hidden" name="document_type_id" id="document_type_id" value="{{document_type.id}}">
            <input type="hidden" name="user_id" id="user_id">
        </div>
    </form>
</div>
</div>
<!-- Preview Modal -->
<div id="previewModal" class="modal">
<div class="modal-content preview-modal">
    <div class="preview-header">
        <div class="preview-title-container">
            <h3 id="previewTitle">Document Preview</h3>
        </div>
        <div class="preview-controls-group">
            <div class="zoom-controls">
                <button class="action-btn" onclick="adjustZoom(-0.2)" title="Reduzir">
                    <i data-feather="zoom-out"></i>
                </button>
                <span id="zoomLevel">100%</span>
                <button class="action-btn" onclick="adjustZoom(0.2)" title="Ampliar">
                    <i data-feather="zoom-in"></i>
                </button>
                <button class="action-btn" onclick="printDocument()" title="Imprimir">
                    <i data-feather="printer"></i>
                </button>
                <button id="openSimpleModalBtn" class="action-btn" onclick="showSimpleModal()" style="display: none;" title="Assinar">
                    <i data-feather="pen-tool"></i>
                </button>
                <button id="saveSignedDocBtn" class="action-btn primary" onclick="saveSignedDocument(currentDocumentId)" title="Salvar" disabled>
                    <i data-feather="save"></i>
                </button>
                <button class="action-btn" onclick="hideModal('previewModal')" title="Fechar">
                    <i data-feather="x"></i>
                </button>
            </div>
        </div>
    </div>
    <div class="preview-container">
        <canvas id="pdfCanvas"></canvas>
        <img id="imagePreview" alt="Image Preview">
        <iframe id="documentPreview" style="width: 100%; height: 100%; border: none;"></iframe>
    </div>
</div>
</div>

<!-- Modal Simples para PDF -->
<div id="simpleModal" class="modal">
<div class="modal-content simple-modal">
    <div class="modal-header">
        <h3>Área de Texto para Assinatura</h3>
        <button class="action-btn" onclick="hideModal('simpleModal')">
            <i data-feather="x"></i>
        </button>
    </div>
    <div class="modal-body">
        <div class="tabs-container">
            <div class="tab-content">
                <div id="text-tab" class="tab-pane active">
                    <div class="form-group">
                        <label for="signatureText">Sua assinatura:</label>
                        <input type="text" id="signatureText" class="form-control" style="display:none;" value="{{name}}">
                        <div id="fontPreview" class="font-preview">Prévia da Fonte</div>
                    </div>
                    <div class="form-group">
                        <label>Escolha a fonte:</label>
                        <div class="font-buttons-container">
                            <div class="font-btn" data-font="Dancing Script">
                                <span style="font-family: 'Dancing Script'">Dancing Script</span>
                            </div>
                            <div class="font-btn" data-font="Great Vibes">
                                <span style="font-family: 'Great Vibes'">Great Vibes</span>
                            </div>
                            <div class="font-btn" data-font="Allura">
                                <span style="font-family: 'Allura'">Allura</span>
                            </div>
                            <div class="font-btn" data-font="Alex Brush">
                                <span style="font-family: 'Alex Brush'">Alex Brush</span>
                            </div>
                            <div class="font-btn" data-font="Sacramento">
                                <span style="font-family: 'Sacramento'">Sacramento</span>
                            </div>
                            <div class="font-btn" data-font="Tangerine">
                                <span style="font-family: 'Tangerine'">Tangerine</span>
                            </div>
                            <div class="font-btn" data-font="Yellowtail">
                                <span style="font-family: 'Yellowtail'">Yellowtail</span>
                            </div>
                            <div class="font-btn" data-font="Mr De Haviland">
                                <span style="font-family: 'Mr De Haviland'">Mr De Haviland</span>
                            </div>
                        </div>
                        <input type="hidden" id="fontFamily" value="Dancing Script">
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-footer">
        <button class="action-btn" onclick="hideModal('simpleModal')">Cancelar</button>
        <button class="action-btn primary" onclick="applySignatureOrText()">Aplicar</button>
    </div>
</div>
</div>
<!-- No template document_types_documents.html, dentro do div com classe preview-container -->
<div id="signatures-container" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none;"></div>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.3/dist/tesseract.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<!-- Importação de fontes do Google para assinaturas -->
<link href="https://fonts.googleapis.com/css2?family=Dancing+Script&family=Great+Vibes&family=Pacifico&family=Allura&family=Alex+Brush&family=Sacramento&family=Tangerine&family=Yellowtail&family=Homemade+Apple&family=Mr+De+Haviland&family=Rouge+Script&family=Pinyon+Script&family=Petit+Formal+Script&family=Playball&family=Lovers+Quarrel&family=Monsieur+La+Doulaise&family=Herr+Von+Muellerhoff&family=Miss+Fajardose&display=swap" rel="stylesheet">
<style>
/* Estilos específicos para o preview de fonte */
#fontPreview {
font-size: 36px;
padding: 20px;
border: 1px solid var(--border-color);
border-radius: 4px;
background-color: white;
color: black;
min-height: 150px;
display: flex;
align-items: center;
justify-content: center;
word-break: break-word;
text-align: center;
line-height: 1.2;
margin-top: 15px;
}

/* Aplicar fontes específicas aos elementos */
.Dancing.Script { font-family: 'Dancing Script', cursive; }
.Great.Vibes { font-family: 'Great Vibes', cursive; }
.Pacifico { font-family: 'Pacifico', cursive; }
.Allura { font-family: 'Allura', cursive; }
.Alex.Brush { font-family: 'Alex Brush', cursive; }
.Sacramento { font-family: 'Sacramento', cursive; }
.Tangerine { font-family: 'Tangerine', cursive; }
.Yellowtail { font-family: 'Yellowtail', cursive; }
.Homemade.Apple { font-family: 'Homemade Apple', cursive; }
.Mr.De.Haviland { font-family: 'Mr De Haviland', cursive; }
.Rouge.Script { font-family: 'Rouge Script', cursive; }
.Pinyon.Script { font-family: 'Pinyon Script', cursive; }
.Petit.Formal.Script { font-family: 'Petit Formal Script', cursive; }
.Playball { font-family: 'Playball', cursive; }
.Lovers.Quarrel { font-family: 'Lovers Quarrel', cursive; }

/* Garantir que o campo de entrada de texto também use a fonte selecionada */
#signatureText {
font-size: 36px;
padding: 15px;
height: auto;
line-height: 1.2;
text-align: center;
}

/* Estilos para os botões de fonte */
.font-buttons-container {
display: grid;
grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
gap: 10px;
margin-bottom: 15px;
max-height: 300px;
overflow-y: auto;
}

.font-btn {
background-color: var(--bg-tertiary);
border: 1px solid var(--border-color);
border-radius: 4px;
padding: 10px;
text-align: center;
cursor: pointer;
transition: all 0.2s ease;
display: flex;
align-items: center;
justify-content: center;
height: 50px;
}

.font-btn span {
font-size: 18px;
color: var(--text-primary);
}

.font-btn:hover {
border-color: var(--accent-color);
background-color: rgba(var(--accent-color-rgb), 0.1);
}

.font-btn.selected {
border: 2px solid var(--accent-color);
background-color: rgba(var(--accent-color-rgb), 0.2);
}

/* Estilos para a página */
.documents-grid {
display: grid;
grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
gap: 1.5rem;
margin-bottom: 2rem;
}

.document-card {
background-color: var(--bg-tertiary);
border-radius: 8px;
padding: 1.5rem;
transition: transform 0.2s;
position: relative;
display: flex;
flex-direction: column;
height: auto;
}

.document-card:hover {
transform: translateY(-2px);
}

.document-header {
display: flex;
align-items: flex-start;
gap: 1rem;
margin-bottom: 1rem;
}

.document-header i {
padding: 0.75rem;
background-color: var(--accent-color);
border-radius: 6px;
}

.document-title {
flex: 1;
}

.document-title h3 {
margin: 0;
margin-bottom: 0.25rem;
}

.document-subtitle {
color: var(--text-secondary);
font-size: 0.875rem;
margin: 0;
}

.document-info {
margin: 1rem 0;
flex-grow: 1;
}

.user-info {
display: flex;
align-items: center;
gap: 1rem;
margin-bottom: 1rem;
}

.user-avatar {
width: 40px;
height: 40px;
background-color: var(--accent-color);
border-radius: 50%;
display: flex;
align-items: center;
justify-content: center;
}

.user-details {
flex: 1;
}

.user-name {
margin: 0;
font-weight: 500;
}

.user-cpf {
margin: 0;
font-size: 0.875rem;
color: var(--text-secondary);
}

.document-meta {
display: flex;
flex-wrap: wrap;
gap: 1rem;
color: var(--text-secondary);
font-size: 0.875rem;
}

.document-meta p {
margin: 0;
display: flex;
align-items: center;
gap: 0.5rem;
}

.document-actions {
display: flex;
justify-content: flex-end;
gap: 0.5rem;
margin-top: 1rem;
}

.filter-section {
background-color: var(--bg-secondary);
border-radius: 8px;
padding: 1.5rem;
margin-bottom: 1.5rem;
}

.filter-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 1rem;
padding-bottom: 1rem;
border-bottom: 1px solid var(--border-color);
}

.filter-header h3 {
display: flex;
align-items: center;
gap: 0.5rem;
margin: 0;
font-size: 1.1rem;
color: var(--text-primary);
}

.filter-grid {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
gap: 1rem;
}

.filter-group {
display: flex;
flex-direction: column;
gap: 0.5rem;
}

.filter-input-wrapper {
position: relative;
width: 100%;
}

.filter-input-wrapper select {
width: 100%;
padding: 0.5rem 2rem 0.5rem 0.75rem;
border: 1px solid var(--border-color);
border-radius: 4px;
background-color: var(--bg-primary);
color: var(--text-primary);
appearance: none;
cursor: pointer;
}

.filter-input-wrapper .select-icon {
position: absolute;
right: 0.75rem;
top: 50%;
transform: translateY(-50%);
pointer-events: none;
width: 16px;
height: 16px;
color: var(--text-secondary);
}

.filter-input-wrapper select:disabled {
opacity: 0.7;
cursor: not-allowed;
}

.filter-input-wrapper select:focus {
outline: none;
border-color: var(--accent-color);
}

.pagination-controls {
display: flex;
align-items: center;
justify-content: center;
gap: 1.5rem;
margin-top: 2rem;
background: var(--bg-secondary);
border-top: 1px solid var(--border-color);
position: relative;
padding: 1rem;
}

.pagination-controls button {
display: flex;
align-items: center;
gap: 0.5rem;
}

.pagination-controls button:disabled {
opacity: 0.5;
cursor: not-allowed;
}

#pageInfo {
color: var(--text-secondary);
}

.no-data {
text-align: center;
padding: 2rem;
color: var(--text-secondary);
}

.no-data i {
font-size: 2rem;
margin-bottom: 0.5rem;
opacity: 0.5;
}

.no-data.error {
color: var(--danger-color);
}

.no-data.error i {
color: var(--danger-color);
}

.back-link {
display: flex;
align-items: center;
gap: 0.5rem;
color: var(--text-secondary);
text-decoration: none;
margin-bottom: 1rem;
}

.back-link:hover {
color: var(--accent-color);
}

.header-title {
display: flex;
flex-direction: column;
}

.header-actions {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 2rem;
}

.loading-overlay {
position: absolute;
top: 0;
left: 0;
right: 0;
bottom: 0;
background-color: rgba(0, 0, 0, 0.5);
display: flex;
align-items: center;
justify-content: center;
border-radius: 8px;
z-index: 10;
}

.form-group {
display: flex;
flex-direction: column;
margin-bottom: 0.5rem !important;
}

.form-grid {
display: grid;
grid-template-columns: 1fr 1fr;
gap: 1rem;
}

.modal-actions {
display: flex;
justify-content: flex-end;
gap: 0.5rem;
margin-top: 1rem;
}

.search-input {
display: flex;
gap: 0.5rem;
}

.search-input input {
flex: 1;
padding: 0.5rem;
border: 1px solid var(--border-color);
border-radius: 4px;
background: var(--bg-tertiary);
color: var(--text-primary);
}

.search-input button {
padding: 0.5rem 1rem;
}

.page-container {
padding: 2rem;
}

/* Modal de visualização em tela cheia */
#previewModal {
display: none;
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background-color: rgba(0, 0, 0, 0.9);
z-index: 2000;
overflow: hidden;
}

.preview-modal {
width: 100% !important;
height: 100vh !important;
max-width: 100% !important;
margin: 0 !important;
padding: 0 !important;
border-radius: 0 !important;
display: flex;
flex-direction: column;
}

.preview-header {
display: flex;
flex-direction: row;
align-items: center;
justify-content: space-between;
padding: 0.75rem;
background-color: var(--bg-secondary);
border-bottom: 1px solid var(--border-color);
z-index: 2001;
width: 100%;
}

.preview-title-container {
flex-shrink: 1;
overflow: hidden;
min-width: 100px;
max-width: 180px;
}

#previewTitle {
font-size: 1rem;
margin: 0;
white-space: nowrap;
overflow: hidden;
text-overflow: ellipsis;
}

.preview-controls-group {
flex-grow: 0;
flex-shrink: 0;
display: flex;
justify-content: flex-end;
}

.zoom-controls {
display: flex;
align-items: center;
gap: 0.25rem;
}

.preview-controls {
display: flex;
justify-content: space-between;
align-items: center;
padding: 1rem;
background-color: var(--bg-secondary);
border-top: 1px solid var(--border-color);
}

/* Estilos para canvas e imagens */
#pdfCanvas {
max-height: 90vh;
box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
}

#imagePreview {
max-height: 90vh;
max-width: 90vw;
object-fit: contain;
transition: transform 0.3s ease;
}

/* Controles do PDF */
.preview-controls {
display: flex;
justify-content: center;
align-items: center;
gap: 1rem;
padding: 1rem;
background-color: var(--bg-secondary);
border-top: 1px solid var(--border-color);
}

/* Estilos para o botão de ação do PDF */
.pdf-action-button {
position: absolute;
bottom: 20px;
right: 20px;
z-index: 100;
padding: 10px 15px;
box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
}

/* Estilos para o modal simples */
.simple-modal {
max-width: 650px;
display: flex;
flex-direction: column;
padding: 0 !important;
}

/* Garante que o modal simples fique sobre o modal de visualização */
#simpleModal {
z-index: 3000; /* Valor mais alto que o z-index do previewModal (2000) */
}

#previewModal {
z-index: 2000;
}

.modal-header {
display: flex;
justify-content: space-between;
align-items: center;
padding: 15px 20px;
border-bottom: 1px solid var(--border-color);
background-color: var(--bg-secondary);
}

.modal-body {
padding: 20px;
flex: 1;
}

.modal-footer {
display: flex;
justify-content: flex-end;
gap: 10px;
padding: 15px 20px;
border-top: 1px solid var(--border-color);
background-color: var(--bg-secondary);
}

/* Tabs */
.tabs-container {
width: 100%;
}

.tab-buttons {
display: flex;
border-bottom: 1px solid var(--border-color);
margin-bottom: 20px;
}

.tab-btn {
padding: 10px 20px;
background: none;
border: none;
cursor: pointer;
color: var(--text-secondary);
font-weight: 500;
transition: all 0.2s ease;
}

.tab-btn.active {
color: var(--accent-color);
border-bottom: 2px solid var(--accent-color);
}

.tab-pane {
display: none;
padding: 10px 0;
}

.tab-pane.active {
display: block;
}

/* Canvas e controles de assinatura */
#modalSignatureCanvas {
width: 100%;
height: 200px;
border: 1px solid var(--border-color);
background-color: white;
margin: 15px 0;
border-radius: 4px;
cursor: crosshair;
}

.signature-controls {
display: flex;
justify-content: flex-end;
gap: 10px;
margin-top: 10px;
}

/* Área de texto de assinatura */
.form-control {
width: 100%;
padding: 10px;
margin-bottom: 15px;
border: 1px solid var(--border-color);
border-radius: 4px;
background-color: var(--bg-tertiary);
color: var(--text-primary);
}

.form-group {
margin-bottom: 20px;
}

.form-group label {
display: block;
margin-bottom: 8px;
font-weight: 500;
}

.font-preview {
padding: 20px;
border: 1px solid var(--border-color);
border-radius: 4px;
background-color: white;
color: black;
min-height: 80px;
font-size: 24px;
display: flex;
align-items: center;
justify-content: center;
margin-top: 15px;
}

.tab-description {
margin-bottom: 10px;
color: var(--text-secondary);
}

.preview-container {
position: relative;
background-color: var(--bg-tertiary);
display: flex;
justify-content: center;
overflow: hidden;
width: 100%;
height: calc(100vh - 120px);
}

/* PDF viewer styling */
.pdf-viewer-container {
width: 100%;
height: 100%;
display: flex;
flex-direction: column;
overflow: hidden;
}

.pdf-pages-container {
width: 100%;
height: 100%;
overflow-y: auto;
overflow-x: auto;
display: flex;
flex-direction: column;
align-items: center;
padding: 20px 0;
}

.pdf-page-wrapper {
margin-bottom: 20px;
background-color: white;
box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
position: relative;
display: flex;
justify-content: center;
}

.pdf-page-canvas {
display: block;
}

.pdf-page-number {
position: absolute;
bottom: -20px;
left: 50%;
transform: translateX(-50%);
background-color: rgba(0, 0, 0, 0.5);
color: white;
padding: 2px 10px;
border-radius: 10px;
font-size: 12px;
opacity: 0.7;
}

.pdf-page-error {
padding: 20px;
background-color: #ffeeee;
color: #cc0000;
text-align: center;
border: 1px solid #cc0000;
margin: 20px;
}

/* Loading indicator */
.pdf-loading {
display: flex;
flex-direction: column;
align-items: center;
justify-content: center;
height: 100%;
width: 100%;
}

.loading-spinner {
border: 4px solid #f3f3f3;
border-top: 4px solid var(--accent-color);
border-radius: 50%;
width: 40px;
height: 40px;
animation: spin 1s linear infinite;
margin-bottom: 15px;
}

@keyframes spin {
0% { transform: rotate(0deg); }
100% { transform: rotate(360deg); }
}

/* Image container */
.image-container {
display: flex;
justify-content: center;
align-items: center;
overflow: auto;
width: 100%;
height: 100%;
background-color: var(--bg-primary);
}

.preview-image {
max-width: 90%;
max-height: 90%;
object-fit: contain;
transition: transform 0.2s ease;
transform-origin: center center;
}

/* Document container */
.document-container {
width: 100%;
height: 100%;
overflow: auto;
}

.document-iframe {
width: 100%;
height: 100%;
border: none;
}

.content-grid {
background-color: var(--bg-secondary);
border-radius: 8px;
padding: 1.5rem;
}

/* Estilos responsivos para mobile */
@media screen and (max-width: 768px) {
.page-container {
    padding: 1rem;
}

.content-grid {
    padding: 1rem;
}

.documents-grid {
    grid-template-columns: 1fr; /* Uma coluna apenas em dispositivos móveis */
    gap: 1rem;
    margin-bottom: 1rem;
}

.document-card {
    margin-bottom: 1rem;
    width: 100%;
    padding: 1rem;
    height: auto;
}

.document-header {
    gap: 0.5rem;
}

.document-header i {
    padding: 0.5rem;
}

.document-info {
    margin: 0.5rem 0;
}

.user-info {
    gap: 0.5rem;
}

.user-avatar {
    width: 32px;
    height: 32px;
}

.document-meta {
    flex-direction: column;
    gap: 0.25rem;
}

.filter-section {
    padding: 1rem;
    margin-bottom: 1rem;
}

.filter-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 1rem;
}

.filter-header h2 {
    font-size: 1.25rem;
    margin-bottom: 0.5rem;
}

.filter-header button {
    width: 100%;
}

.pagination-controls {
    padding: 0.5rem;
    margin-top: 0;
    flex-wrap: nowrap;
    justify-content: space-between;
    gap: 0.25rem;
    width: 100%;
    white-space: nowrap;
    overflow: hidden;
}

.pagination-controls button {
    min-width: auto;
    padding: 0.4rem 0.5rem;
    font-size: 0.75rem;
}

.pagination-controls button i {
    width: 14px;
    height: 14px;
}

.pagination-controls span {
    min-width: auto;
    font-size: 0.75rem;
    text-align: center;
}

/* Ocultar textos dos botões em telas pequenas, mantendo apenas ícones */
.pagination-controls .btn-text {
    display: none;
}

/* Mantendo o estilo original para os botões de ação */
.document-actions {
    display: flex;
    justify-content: flex-end;
    gap: 0.5rem;
    margin-top: 0.5rem;
}

/* Modal adjustments for mobile */
.modal-content {
    width: 95%;
    max-width: 95% !important;
    margin: 10px auto;
    padding: 1rem;
}

.preview-modal {
    padding: 0 !important;
}

.preview-header {
    padding: 0.5rem;
    flex-wrap: wrap;
}

.preview-header {
    padding: 0.5rem;
}

.preview-title-container {
    max-width: 120px;
}

#previewTitle {
    font-size: 0.875rem;
}

.zoom-controls {
    gap: 2px;
}

.preview-controls-group .action-btn {
    width: 32px;
    height: 32px;
    padding: 4px;
}

#zoomLevel {
    font-size: 0.75rem;
    min-width: 36px;
    text-align: center;
}

.zoom-controls button {
    padding: 0.3rem !important;
}

#zoomLevel {
    font-size: 0.75rem;
}

.font-buttons-container {
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
}

/* Fix for PDF viewer on mobile */
.pdf-pages-container {
    padding: 10px 0;
}

.pdf-page-wrapper {
    margin-bottom: 10px;
}
}
</style>
<script src="{{ url_for('static', filename='js/signature-modal.js') }}"></script>
<script>
    let currentPage = 1;
    const perPage = 9;
    let totalPages = 1;
    let itemToDelete = null;

    async function loadFilterOptions() {
        const contentDiv = document.getElementById('documentsContent');
        showLoading(contentDiv);

        const resetSelect = (selectId, placeholder) => {
            const select = document.getElementById(selectId);
            if (select) {
                select.innerHTML = `<option value="">${placeholder}</option>`;
                select.disabled = false;
            }
        };

        try {
            // Load departments
            const deptResponse = await fetch('/api/departments');
            if (!deptResponse.ok) {
                const errorData = await deptResponse.json();
                throw new Error(errorData.error || 'Failed to load departments');
            }
            const departments = await deptResponse.json();
            if (!Array.isArray(departments)) {
                throw new Error('Invalid departments data format');
            }
            populateFilterSelect('filterDepartment', departments);
            populateFilterSelect('documentDepartment', departments);

            // Load users
            const userResponse = await fetch('/api/users');
            if (!userResponse.ok) {
                const errorData = await userResponse.json();
                throw new Error(errorData.error || 'Failed to load users');
            }
            const userData = await userResponse.json();
            if (!userData.users || !Array.isArray(userData.users)) {
                throw new Error('Invalid users data format');
            }
            populateFilterSelect('filterUser', userData.users);
            populateFilterSelect('documentUser', userData.users);

            // Reset category and document type filters
            resetSelect('filterCategory', 'Categories');
            resetSelect('filterDocumentType', 'Types');
            resetSelect('documentCategory', 'Select Category');
            resetSelect('documentType', 'Select Document Type');

        } catch (error) {
            console.error('Error loading filter options:', error);
            showNotification(error.message || 'Failed to load filter options. Please try again.', 'error');

            // Reset all filters to a safe state with error indication
            const filterIds = {
                'filterDepartment': 'Departments',
                'documentDepartment': 'Department',
                'filterCategory': 'Categories',
                'documentCategory': 'Category',
                'filterDocumentType': 'Document Types',
                'documentType': 'Document Type',
                'filterUser': 'Users',
                'documentUser': 'User'
            };

            Object.entries(filterIds).forEach(([id, label]) => {
                resetSelect(id, `${label} (Error loading)`);
            });
        } finally {
            hideLoading(contentDiv);
        }
    }

    function populateFilterSelect(selectId, items) {
        const select = document.getElementById(selectId);
        if (!select || !Array.isArray(items)) return;

        const currentValue = select.value;
        select.innerHTML = '';

        // Add default option
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = selectId.includes('filter') ? 'All' : 'Select';
        defaultOption.textContent += ' ' + (selectId.includes('User') ? 'Users' : 
                                        selectId.includes('Department') ? 'Departments' : 
                                        selectId.includes('Category') ? 'Categories' : 
                                        'Types');
        select.appendChild(defaultOption);

        items.forEach(item => {
            const option = document.createElement('option');
            option.value = item.id;
            option.textContent = item.name;
            select.appendChild(option);
        });

        if (currentValue) select.value = currentValue;
    }

    async function applyFilters() {
        const filters = {
            document_type_id: '{{document_type.id}}',
            user_cpf: document.getElementById('user-cpf-filter').value
        };

        // Ensure document_type_id is never empty
        if (!filters.document_type_id) {
            filters.document_type_id = '{{document_type.id}}';
        }

        // Store filters in URL params
        const params = new URLSearchParams(filters);

        // Reload documents with filters
        await loadDocuments(1, filters);
    }

    async function applyFiltersDepartment(departmentId) {
        const categorySelect = document.getElementById('filterCategory');
        const typeSelect = document.getElementById('filterDocumentType');

        categorySelect.innerHTML = '<option value="">Loading categories...</option>';
        categorySelect.disabled = true;
        typeSelect.innerHTML = '<option value="">Types</option>';
        typeSelect.disabled = true;

        try {
            if (!departmentId) {
                categorySelect.innerHTML = '<option value="">Categories</option>';
                typeSelect.innerHTML = '<option value="">Types</option>';
                await applyFilters();
                return;
            }
            await applyFilters();
            const response = await fetch(`/api/categories/departments/${departmentId}/categories`);
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Failed to load categories');
            }
            const data = await response.json();

            if (!data.categories || !Array.isArray(data.categories)) {
                throw new Error('Invalid categories data format');
            }

            categorySelect.innerHTML = `
                <option value="">All Categories</option>
                ${data.categories.map(cat => `
                    <option value="${cat.id}">${cat.name}</option>
                `).join('')}`;
        } catch (error) {
            console.error('Error loading categories:', error);
            showNotification(error.message, 'error');
            categorySelect.innerHTML = '<option value="">Error loading categories</option>';
        } finally {
            categorySelect.disabled = false;
            typeSelect.disabled = false;
        }
    }

    async function applyFiltersCategory(categoryId) {
        const typeSelect = document.getElementById('filterDocumentType');
        typeSelect.innerHTML = '<option value="">Loading document types...</option>';
        typeSelect.disabled = true;

        try {
            if (!categoryId) {
                typeSelect.innerHTML = '<option value="">Types</option>';
                await applyFilters();
                return;
            }
            await applyFilters();
            const response = await fetch(`/api/document_types/categories/${categoryId}/types`);
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Failed to load document types');
            }
            const data = await response.json();

            if (!Array.isArray(data)) {
                throw new Error('Invalid document types data format');
            }

            typeSelect.innerHTML = `
                <option value="">All Document Types</option>
                ${data.map(type => 
                    `<option value="${type.id}">${type.name}</option>`
                ).join('')}`;
        } catch (error) {
            console.error('Error loading document types:', error);
            showNotification(error.message, 'error');
            typeSelect.innerHTML = '<option value="">Error loading document types</option>';
        } finally {
            typeSelect.disabled = false;
        }
    }

    function getFileIcon(filename) {
        if (!filename) return 'file';

        const ext = filename.split('.').pop().toLowerCase();
        switch (ext) {
            case 'pdf': return 'file-text';
            case 'doc': case 'docx': return 'file-text';
            case 'xls': case 'xlsx': return 'file';
            case 'ppt': case 'pptx': return 'file';
            case 'txt': return 'file-text';
            case 'jpg': case 'jpeg': case 'png': case 'gif': case 'bmp': return 'image';
            case 'zip': case 'rar': case '7z': case 'tar': case 'gz': return 'archive';
            case 'mp3': case 'wav': case 'ogg': return 'music';
            case 'mp4': case 'avi': case 'mov': return 'video';
            default: return 'file';
        }
    }

    setupFormValidation('addDocumentForm', {
        'documentTitle': [
            ValidationRules.required,
            ValidationRules.minLength(3),
            ValidationRules.maxLength(100)
        ],
        'documentDepartment': [ValidationRules.required],
        'documentCategory': [ValidationRules.required],
        'documentType': [ValidationRules.required],
        'documentUser': [ValidationRules.required],
        'documentFile': [ValidationRules.required]
    });

    async function loadDocumentTypes(categoryId) {
        const typeSelect = document.getElementById('documentType');
        typeSelect.innerHTML = '<option value="">Loading document types...</option>';
        typeSelect.disabled = true;

        try {
            if (!categoryId) {
                typeSelect.innerHTML = '<option value="">Select Document Type</option>';
                return;
            }

            const response = await fetch(`/api/document_types/categories/${categoryId}/types`);
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Failed to load document types');
            }
            const data = await response.json();

            if (!Array.isArray(data)) {
                throw new Error('Invalid document types data format');
            }

            typeSelect.innerHTML = `
                <option value="">Select Document Type</option>
                ${data.map(type => 
                    `<option value="${type.id}">${type.name}</option>`
                ).join('')}`;
        } catch (error) {
            console.error('Error loading document types:', error);
            showNotification(error.message, 'error');
            typeSelect.innerHTML = '<option value="">Error loading document types</option>';
        } finally {
            typeSelect.disabled = false;
        }
    }

    async function loadDepartmentCategories(departmentId) {
        const categorySelect = document.getElementById('documentCategory');
        const typeSelect = document.getElementById('documentType');

        categorySelect.innerHTML = '<option value="">Loading categories...</option>';
        categorySelect.disabled = true;
        typeSelect.innerHTML = '<option value="">Select Document Type</option>';
        typeSelect.disabled = true;

        try {
            if (!departmentId) {
                categorySelect.innerHTML = '<option value="">Select Category</option>';
                return;
            }

            const response = await fetch(`/api/categories/departments/${departmentId}/categories`);
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Failed to load categories');
            }
            const data = await response.json();

            if (!data.categories || !Array.isArray(data.categories)) {
                throw new Error('Invalid categories data format');
            }

            categorySelect.innerHTML = `
                <option value="">Select Category</option>
                ${data.categories.map(cat => `
                    <option value="${cat.id}">${cat.name}</option>`
                ).join('')}`;
        } catch (error) {
            console.error('Error loading categories:', error);
            showNotification(error.message, 'error');
            categorySelect.innerHTML = '<option value="">Error loading categories</option>';
        } finally {
            categorySelect.disabled = false;
            typeSelect.disabled = false;
        }
    }

    async function createDocument(event) {
        event.preventDefault();
        const form = event.target;
        const submitButton = form.querySelector('button[type="submit"]');       
        if (!validateForm(form)) {
            return;
        }
        showLoading(submitButton);
        const formData = new FormData(form);
        try {
            const response = await fetch('/api/documents', {
                method: 'POST',
                body: formData
            });
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Failed to create document');
            }
            hideModal('addDocumentModal');
            form.reset();
            document.getElementById('user_id').value =''
            const filters = {
                document_type_id: '{{document_type.id}}',
            };
            await loadDocuments(currentPage,filters);
            showNotification('Document created successfully', 'success');
        } catch (error) {
            console.error('Error creating document:', error);
            showNotification(error.message, 'error');
        } finally {
            hideLoading(submitButton);
        }
    }

    function showDeleteConfirmation(id) {
        itemToDelete = id;
        showModal('deleteConfirmModal');
        feather.replace();
    }

    async function confirmDelete() {
        if (!itemToDelete) return;

        const id = itemToDelete;
        hideModal('deleteConfirmModal');
        const card = document.querySelector(`.document-card[data-id="${id}"]`);
        showLoading(card);

        try {
            const response = await fetch(`/api/documents/${id}`, {
                method: 'DELETE'
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Failed to delete document');
            }
            const filters = {
                document_type_id: '{{document_type.id}}',
                user_cpf: document.getElementById('user-cpf-filter').value
            };
            await loadDocuments(currentPage,filters);
            showNotification('Document deleted successfully', 'success');
        } catch (error) {
            console.error('Error deleting document:', error);
            showNotification(error.message, 'error');
        } finally {
            hideLoading(card);
            itemToDelete = null;
        }
    }

    async function loadDocuments(page = 1, filters = {}) {
        const contentDiv = document.getElementById('documentsContent');
        showLoading(contentDiv);

        try {
            // Always include document_type_id in filters if not already present
            if (!filters.document_type_id) {
                filters.document_type_id = '{{document_type.id}}';
            }

            const params = new URLSearchParams({
                page: page,
                per_page: perPage,
                ...filters
            });

            const response = await fetch(`/api/documents?${params}`);
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Failed to load documents');
            }

            const data = await response.json();
            if (!data || !Array.isArray(data.documents)) {
                throw new Error('Invalid response format');
            }

            currentPage = page;
            totalPages = data.total_pages || 1;

            const gridHTML = data.documents.length === 0 ? `
                <div class="documents-grid">
                    <div class="no-data">
                        <i data-feather="inbox"></i>
                        <p>No documents found</p>
                    </div>
                </div>` : `
                <div class="documents-grid">
                    ${data.documents.map(doc => `
                        <div class="document-card" data-id="${doc.id}">
                            <div class="document-header">
                                <i data-feather="${getFileIcon(doc.name)}"></i>
                                <div class="document-title">
                                    <h3>${doc.document_type_name || 'Unknown Type'}</h3>
                                    <p class="document-subtitle">${doc.titulo || doc.name}</p>
                                </div>
                            </div>
                            <div class="document-info">
                                <div class="user-info">
                                    <div class="user-avatar">
                                        <i data-feather="user"></i>
                                    </div>
                                    <div class="user-details">
                                        <p class="user-name">${doc.user_name || 'Unknown User'}</p>
                                        <p class="user-cpf">${doc.user_cpf || 'No CPF'}</p>
                                    </div>
                                </div>
                                <div class="document-meta">
                                    <p><i data-feather="calendar"></i> ${new Date(doc.created_at).toLocaleDateString()}</p>
                                </div>
                            </div>
                            <div class="document-actions">
                                <button class="action-btn" onclick="previewDocument('${doc.url}', '${doc.name}','${doc.id}')">
                                    <i data-feather="eye"></i>
                                </button>
                                <button class="action-btn" onclick="downloadDocument('${doc.url}', '${doc.id}')">
                                    <i data-feather="download"></i>
                                </button>
                                <button class="action-btn danger" onclick="deleteDocument('${doc.id}')">
                                    <i data-feather="trash-2"></i>
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>`;

            contentDiv.innerHTML = gridHTML + `
                <div class="pagination-controls">
                    <button class="action-btn" onclick="changePage(currentPage - 1)" id="prevPage" ${currentPage <= 1 ? 'disabled' : ''}>
                        <i data-feather="chevron-left"></i> Previous
                    </button>
                    <span id="pageInfo">Page ${currentPage} of ${totalPages}</span>
                    <button class="action-btn" onclick="changePage(currentPage + 1)" id="nextPage" ${currentPage >= totalPages ? 'disabled' : ''}>
                        Next <i data-feather="chevron-right"></i>
                    </button>
                </div>`;

            feather.replace();
            updatePaginationControls();
        } catch (error) {
            console.error('Error loading documents:', error);
            contentDiv.innerHTML = `
                <div class="documents-grid">
                    <div class="no-data error">
                        <i data-feather="alert-circle"></i>
                        <p>${error.message || 'Error loading documents. Please try again.'}</p>
                    </div>
                </div>`;
            feather.replace();
            showNotification(error.message || 'Failed to load documents', 'error');
        } finally {
            hideLoading(contentDiv);
        }
    }

    async function searchUser() {
        try {

            openPopup();
            if(document.getElementById(`user_cpf`).value == ''){
                closePopup();
                showNotification('Enter with CPF', 'error');
                return;
            } 

            const params = new URLSearchParams({
                cpf: document.getElementById(`user_cpf`).value,
            });

            const response = await fetch(`/api/users?${params}`);
            if (!response.ok) {
                closePopup();
                showNotification('User not found', 'error');
                document.getElementById('name-user').value = '';
                document.getElementById('user_id').value ='';
                return;
            }
            const data = await response.json();
            usuario = data['users'][0]

            if(!usuario){
                closePopup();
                showNotification('User not found', 'error');
                document.getElementById('name-user').value = '';
                document.getElementById('user_id').value ='';
                return;
            }

            document.getElementById('name-user').value = usuario['name'];
            document.getElementById('user_id').value = usuario['id'];
            closePopup();
        } catch (error) {
            console.error('Error loading documents:', error);
            showNotification(error.message || 'Failed to load users', 'error');

        } finally {
            closePopup();
        }
    }

    function updatePaginationControls() {
        document.getElementById('prevPage').disabled = currentPage <= 1;
        document.getElementById('nextPage').disabled = currentPage >= totalPages;
        document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
    }

    function changePage(newPage) {
        if (newPage >= 1 && newPage <= totalPages) {
            const urlParams = new URLSearchParams(window.location.search);
            const filters = {
                department_id: urlParams.get('department_id') || '',
                category_id: urlParams.get('category_id') || '',
                document_type_id: '{{document_type.id}}', // Always use the current document_type_id

            };

            // Clean empty filters
            Object.keys(filters).forEach(key => {
                if (filters[key] === '') {
                    delete filters[key];
                }
            });

            loadDocuments(newPage, filters);
        }
    }

    function showModal(modalId) {
        document.getElementById(modalId).style.display = 'block';
    }

    function hideModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
    }

    function showAddDocumentModal() {
        document.getElementById('addDocumentForm').reset();
        showModal('addDocumentModal');
    }

    function deleteDocument(id) {
        showDeleteConfirmation(id);
    }

    async function downloadDocument(url, id) {
        if (!url) {
            showNotification('Document URL is not available', 'error');
            return;
        }

        try {
            // Track download count
            await fetch(`/api/documents/${id}/download-count`, {
                method: 'POST',
                headers: get_auth_headers()
            });
            window.open(url, '_blank');
        } catch (error) {
            consoleerror('Error downloading document:', error);
            showNotification('Failed to download document', 'error');
        }
    }

    const pdfjsLib = window['pdfjs-dist/build/pdf'];
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

    let currentPdf = null;
    let zoomLevel = 1.0;
    var margins = { top: 20, right: 20, bottom: 20, left: 20 };
    var signatureFields = [];
    var currentSignature = "{{signature}}";
    var findSignature = null;
    var rectignature = null;
    var isIgnature = false;

    let currentDocumentId;

    function get_auth_headers() {
        return {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
        };
    }

    async function previewDocument(url, filename, id) {
        openPopup();
        // Track view count
        try {
            await fetch(`/api/documents/${id}/view-count`, {
                method: 'POST',
                headers: get_auth_headers()
            });
        } catch (error) {
            console.error('Error tracking view count:', error);
        }

        const previewTitle = document.getElementById('previewTitle');
        const previewContainer = document.querySelector('.preview-container');
        const zoomLevelSpan = document.getElementById('zoomLevel');
        currentPdf = null;
        findSignature = null;
        rectignature = null;
        isIgnature = false;
        currentDocumentId = id;
        zoomLevel = 1.8;
        zoomLevelSpan.textContent = `${(zoomLevel * 100).toFixed(0)}%`;
        while (previewContainer.firstChild) {
            previewContainer.removeChild(previewContainer.firstChild);
        }
        previewTitle.textContent = filename;
        const fileType = filename.split('.').pop().toLowerCase();
        try {
            if (fileType === 'pdf') {
                document.getElementById('previewTitle').style.display = 'block';
                document.getElementById('previewTitle').disabled = true;
                document.getElementById('saveSignedDocBtn').disabled = true;
                const pdfViewerContainer = document.createElement('div');
                pdfViewerContainer.className = 'pdf-viewer-container';
                previewContainer.appendChild(pdfViewerContainer);
                const loadingIndicator = document.createElement('div');
                loadingIndicator.className = 'pdf-loading';
                loadingIndicator.innerHTML = '<div class="loading-spinner"></div><p>Loading PDF...</p>';
                pdfViewerContainer.appendChild(loadingIndicator);
                const proxyUrl = `/proxy/storage/${url.replace('https://storage.googleapis.com/', '')}`;
                const loadingTask = pdfjsLib.getDocument(proxyUrl);
                currentPdf = await loadingTask.promise;
                pdfViewerContainer.removeChild(loadingIndicator);
                await renderPdfPages(pdfViewerContainer, id);
                document.getElementById("openSimpleModalBtn").style.display = 'block';
            } else if (['jpg', 'jpeg', 'png', 'gif'].includes(fileType)) {
                document.getElementById('previewTitle').style.display = 'none';
                document.getElementById('previewTitle').disabled = true;
                zoomLevel = 1.0;
                const imgContainer = document.createElement('div');
                imgContainer.className = 'image-container';
                previewContainer.appendChild(imgContainer);
                const imageElement = document.createElement('img');
                imageElement.className = 'preview-image';
                imageElement.alt = 'Image Preview';
                imageElement.src = url;
                imgContainer.appendChild(imageElement);
                imageElement.style.transform = `scale(${zoomLevel})`;
                imageElement.style.transformOrigin = 'center center';  
                document.getElementById("openSimpleModalBtn").style.display = 'none'; 
            } 
            closePopup();
            showModal('previewModal');
        } catch (error) {
            console.error('Error previewing document:', error);
            showNotification('Failed to preview document', 'error');
        }

        if(!currentSignature)
            showSimpleModal();
    }

    async function renderPdfPages(container, id) {
        if (!currentPdf) return;
        const totalPages = currentPdf.numPages;    
        const pagesContainer = document.createElement('div');
        pagesContainer.className = 'pdf-pages-container';
        container.appendChild(pagesContainer);
        signatureFields = []
        try {
            if(findSignature == null){
                const response = await fetch(`/api/pdf-analyzer/${id}`, {
                    method: 'GET',
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error);
                } 
                findSignature = await response.json();  
            }    
        } catch (error) {
            showNotification(error.message, 'error');
        } 
        for (let pageNum = 1; pageNum <= totalPages; pageNum++) {
            const pageContainer = document.createElement('div');
            pageContainer.className = 'pdf-page-wrapper';
            pageContainer.dataset.pageNumber = pageNum;
            pagesContainer.appendChild(pageContainer);
            const pageCanvas = document.createElement('canvas');
            pageCanvas.className = 'pdf-page-canvas';
            pageContainer.appendChild(pageCanvas);
            await renderPdfPage(pageNum, pageCanvas);
        }
    }

    async function renderPdfPage(pageNumber, canvas) {
        try {
            const page = await currentPdf.getPage(pageNumber);
            const context = canvas.getContext('2d');
            const viewport = page.getViewport({ scale: zoomLevel });
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            const renderContext = {
                canvasContext: context,
                viewport: viewport
            };           
            await page.render(renderContext).promise;
            if(!isIgnature){
                await this.detectSignatureFields((pageNumber - 1), canvas, viewport);
            }else{
                rectignature = findSignature.resultados[pageNumber-1].rect;
                const { width: pageWidth, height: pageHeight } = viewport;
                const [x0, y0] = viewport.convertToViewportPoint(rectignature.x0, rectignature.y0);
                const [x1, y1] = viewport.convertToViewportPoint(rectignature.x1, rectignature.y1);
                const field = {
                    x: x0,
                    y: (viewport.height - y1) - 6 ,
                    width: x1 - x0,
                    height: (y1 - y0) - 10
                };
                field.x = Math.max(this.margins.left, Math.min(field.x, pageWidth - field.width - this.margins.right));
                field.y = Math.max(this.margins.top, Math.min(field.y, pageHeight - field.height - this.margins.bottom));
                this.signatureFields.push(field);
                this.placeSignature(null, canvas, field);
            }
            canvas.addEventListener('click', (e) => {
                    if (currentSignature) {
                        document.getElementById('saveSignedDocBtn').disabled = false;
                        const [x0, y0] = viewport.convertToViewportPoint(rectignature.x0, rectignature.y0);
                        const [x1, y1] = viewport.convertToViewportPoint(rectignature.x1, rectignature.y1);
                        const field =  this.findClickedField(x0, (viewport.height - y1) - 6);
                        if (field) {
                            this.placeSignature(e, canvas, field);
                        }
                    }
                });
            if (currentPdf.numPages > 1) {
                const pageNumberIndicator = document.createElement('div');
                pageNumberIndicator.className = 'pdf-page-number';
                pageNumberIndicator.textContent = `${pageNumber} / ${currentPdf.numPages}`;
                canvas.parentNode.appendChild(pageNumberIndicator);
            }

        } catch (error) {
            console.error(`Error rendering PDF page ${pageNumber}:`, error);
            const errorMsg = document.createElement('div');
            errorMsg.className = 'pdf-page-error';
            errorMsg.textContent = `Error loading page ${pageNumber}`;
            canvas.parentNode.appendChild(errorMsg);
        }
    }

    async function detectSignatureFields(pageNumber, canvas, viewport) {
            const ctx = canvas.getContext('2d');
            const { width: pageWidth, height: pageHeight } = viewport;
            if (findSignature != null) {
                if(findSignature.resultados[pageNumber].has_signature == true){
                    rectignature = findSignature.resultados[pageNumber].rect;
                    const [x0, y0] = viewport.convertToViewportPoint(rectignature.x0, rectignature.y0);
                    const [x1, y1] = viewport.convertToViewportPoint(rectignature.x1, rectignature.y1);
                    const field = {
                        x: x0,
                        y: (viewport.height - y1) - 6 ,
                        width: x1 - x0,
                        height: (y1 - y0) - 10
                    };
                    field.x = Math.max(this.margins.left, Math.min(field.x, pageWidth - field.width - this.margins.right));
                    field.y = Math.max(this.margins.top, Math.min(field.y, pageHeight - field.height - this.margins.bottom));
                    this.signatureFields.push(field);
                    ctx.save();
                    ctx.strokeStyle = '#2196F3';
                    ctx.fillStyle = 'rgba(33, 150, 243, 0.1)';
                    ctx.lineWidth = 2;
                    ctx.setLineDash([5, 3]);
                    ctx.strokeRect(field.x, field.y, field.width, field.height);
                    ctx.fillRect(field.x, field.y, field.width, field.height);
                    ctx.fillStyle = '#2196F3';
                    const iconFontSize = 10 * zoomLevel;
                    const textFontSize = 8 * zoomLevel;
                    ctx.font = `${iconFontSize}px Arial`;
                    ctx.fillText('✒️', (field.x * 2)  + (25 * zoomLevel), field.y + (field.height / 2));
                    ctx.font = `${textFontSize}px Arial`;
                    ctx.fillStyle = '#666';
                    ctx.fillText('Clique para assinar', field.width , field.y + (field.height / 2));
                    }else{

                // esta parte para rubircar as paginas 
                }
            }
        }

    function findClickedField(x, y) {
            return this.signatureFields.find(field => 
                x >= field.x && 
                y >= field.y
            );
        }

    async function addSignature(signatureData) {
            currentSignature = signatureData;
            try {
                if(signatureData != null){
                    const response = await fetch(`/api/signature`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            signature : currentSignature
                        })
                    });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Failed to create signature');
                    } 
                }    
            } catch (error) {
                console.error('Error creating signature:', error);
                showNotification(error.message, 'error');
            } 
        }

    async function placeSignature(event, canvas, field) {
        const ctx = canvas.getContext('2d');
        ctx.clearRect(field.x, field.y, field.width, field.height);
        const img = new Image();
        img.src = this.currentSignature;
        img.onload = () => {
            ctx.imageSmoothingEnabled = true;
            ctx.imageSmoothingQuality = "high";

            // Calculate aspect ratio
            const imgRatio = img.width / img.height;

            // Set maximum size relative to field
            const maxWidth = field.width * 1.0; // 90% of field width
            const maxHeight = field.height * 0.9; // 80% of field height

            let drawWidth, drawHeight;

            // Calculate dimensions while maintaining aspect ratio
            if (imgRatio > 1) {
                // Image is wider than tall
                drawWidth = Math.min(maxWidth, field.width);
                drawHeight = drawWidth / imgRatio;

                // If height is too large, scale down
                if (drawHeight > maxHeight) {
                    drawHeight = maxHeight;
                    drawWidth = drawHeight * imgRatio;
                }
            } else {
                // Image is taller than wide or square
                drawHeight = Math.min(maxHeight, field.height);
                drawWidth = drawHeight * imgRatio;

                // If width is too large, scale down
                if (drawWidth > maxWidth) {
                    drawWidth = maxWidth;
                    drawHeight = drawWidth / imgRatio;
                }
            }

            // Center the image in the field
            const offsetX = field.x + (field.width - drawWidth) / 2;
            const offsetY = field.y + (field.height - drawHeight) / 2;

            ctx.drawImage(img, offsetX, offsetY, drawWidth, drawHeight);
            isIgnature = true;
        };
    }

    async function   getSignaturePosition() {
            return this.signaturePosition;
        }

    async function adjustZoom(delta) {
        const oldZoom = zoomLevel;
        zoomLevel += delta;
        zoomLevel = Math.max(0.2, Math.min(3, zoomLevel));
        if (oldZoom === zoomLevel) return;
        const zoomLevelSpan = document.getElementById('zoomLevel');
        zoomLevelSpan.textContent = `${(zoomLevel * 100).toFixed(0)}%`;
        const previewContainer = document.querySelector('.preview-container');
        const pdfContainer = document.querySelector('.pdf-viewer-container');
        const imageElement = document.querySelector('.preview-image');
        if (pdfContainer && currentPdf) {
            const scrollContainer = document.querySelector('.pdf-pages-container');
            const scrollRatio = scrollContainer.scrollTop / scrollContainer.scrollHeight;
            const pagesContainer = document.querySelector('.pdf-pages-container');
            if (pagesContainer) {
                pdfContainer.removeChild(pagesContainer);
            }
            await renderPdfPages(pdfContainer);
            const newScrollContainer = document.querySelector('.pdf-pages-container');
            setTimeout(() => {
                newScrollContainer.scrollTop = scrollRatio * newScrollContainer.scrollHeight;
            }, 50);
        } else if (imageElement) {
            imageElement.style.transform = `scale(${zoomLevel})`;
            imageElement.style.transformOrigin = 'center center';
        }
    }

    // Salvar o documento com as assinaturas
    async function saveSignedDocument(documentId) {
    try {
        showNotification('Salvando documento assinado...', 'info');
        openPopup();
        // Get the canvas with the signed PDF
        const canvas = document.querySelector('.pdf-page-canvas');
        if (!canvas) {
            throw new Error('Canvas not found');
        }

        // Convert canvas to blob
        const blob = await new Promise(resolve => canvas.toBlob(resolve, 'application/pdf'));

        // Create form data
        const formData = new FormData();
        formData.append('file', blob, 'signed_document.pdf');

        // Send the signed document to the server using the correct endpoint
        const response = await fetch(`/api/pdf-analyzer/${documentId}`, {
            method: 'POST',
            body: formData
        });

        if (!response.ok) {
            throw new Error('Failed to save signed document');
        }

        showNotification('Documento assinado salvo com sucesso!', 'success');
        closePopup();
        hideModal('previewModal');
        await loadDocuments(currentPage); // Reload the documents list

    } catch (error) {
        console.error('Erro ao salvar documento assinado:', error);
        showNotification('Erro ao salvar o documento assinado: ' + error.message, 'error');
    }
    }

    document.addEventListener('DOMContentLoaded', () => {
        const styleElement = document.createElement('style');
        styleElement.textContent = `
            /* Container styling */
            .preview-container {
                position: relative;
                background-color: var(--bg-tertiary);
                display: flex;
                justify-content: center;
                overflow: hidden;
                width: 100%;
                height: calc(100vh - 120px);
            }

            /* PDF viewer styling */
            .pdf-viewer-container {
                width: 100%;
                height: 100%;
                display: flex;
                flex-direction: column;
                overflow: hidden;
            }

            .pdf-pages-container {
                width: 100%;
                height: 100%;
                overflow-y: auto;
                overflow-x: auto;
                display: flex;
                flex-direction: column;
                align-items: center;
                padding: 20px 0;
            }

            .pdf-page-wrapper {
                margin-bottom: 20px;
                background-color: white;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
                position: relative;
                display: flex;
                justify-content: center;
            }

            .pdf-page-canvas {
                display: block;
            }

            .pdf-page-number {
                position: absolute;
                bottom: -20px;
                left: 50%;
                transform: translateX(-50%);
                background-color: rgba(0, 0, 0, 0.5);
                color: white;
                padding: 2px 10px;
                border-radius: 10px;
                font-size: 12px;
                opacity: 0.7;
            }

            .pdf-page-error {
                padding: 20px;
                background-color: #ffeeee;
                color: #cc0000;
                text-align: center;
                border: 1px solid #cc0000;
                margin: 20px;
            }

            /* Loading indicator */
            .pdf-loading {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                height: 100%;
                width: 100%;
            }

            .loading-spinner {
                border: 4px solid #f3f3f3;
                border-top: 4px solid var(--accent-color);
                border-radius: 50%;
                width: 40px;
                height: 40px;
                animation: spin 1s linear infinite;
                margin-bottom: 15px;
            }

            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }

            /* Image container */
            .image-container {
                display: flex;
                justify-content: center;
                align-items: center;
                overflow: auto;
                width: 100%;
                height: 100%;
                background-color: var(--bg-primary);
            }

            .preview-image {
                max-width: 90%;
                max-height: 90%;
                object-fit: contain;
                transition: transform 0.2s ease;
                transform-origin: center center;
            }

            /* Document container */
            .document-container {
                width: 100%;
                height: 100%;
                overflow: auto;
            }

            .document-iframe {
                width: 100%;
                height: 100%;
                border: none;
            }
        `;

        document.head.appendChild(styleElement);
    });

    function updatePreviewModalStructure() {
        const previewModal = document.getElementById('previewModal');
        if (!previewModal) return;

        const previewContainer = previewModal.querySelector('.preview-container');
        if (!previewContainer) return;
    }

    function hideModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
        if (modalId === 'previewModal') {
            currentPdf = null;
        }
    }

    function showSimpleModal() {
        document.getElementById('simpleModal').style.display = 'block';
        feather.replace();
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadDocuments();

    });


</script>
{% endblock %}